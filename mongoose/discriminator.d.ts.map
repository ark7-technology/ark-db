{"version":3,"sources":["mongoose/discriminator.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,QAAQ,EAAmB,MAAM,UAAU,CAAC;AAErD,OAAO,EAAE,WAAW,EAAE,MAAM,YAAY,CAAC;AACzC,OAAO,EAAE,YAAY,EAAE,MAAM,SAAS,CAAC;AACvC,OAAO,EAAE,aAAa,EAAE,KAAK,EAAqB,MAAM,SAAS,CAAC;AAGlE,qBAAa,aAAc,SAAQ,aAAa;WAChC,cAAc,CAC1B,CAAC,SAAS,YAAY,CAAC,QAAQ,EAAE,GAAG,CAAC,GAAG,OAAO,aAAa,EAC5D,CAAC,SAAS,OAAO,KAAK,EAEtB,IAAI,EAAE,CAAC,EACP,CAAC,EAAE,CAAC,GACH,YAAY,CAAC,CAAC,GAAG,YAAY,CAAC,CAAC,CAAC,GAAG,QAAQ,EAAE,CAAC,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC;WAI9D,qBAAqB,CACjC,CAAC,SAAS,YAAY,CAAC,QAAQ,EAAE,GAAG,CAAC,GAAG,OAAO,aAAa,EAC5D,CAAC,SAAS,OAAO,KAAK,EAEtB,IAAI,EAAE,CAAC,EACP,CAAC,EAAE,CAAC,GACH,YAAY,CAAC,CAAC,GAAG,YAAY,CAAC,CAAC,CAAC,GAAG,QAAQ,EAAE,CAAC,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC,GAClE,CAAC,GACD,CAAC,GACD,WAAW;CAGd","file":"discriminator.d.ts","sourcesContent":["import * as _ from 'underscore';\r\nimport { Document, Model as MModel } from 'mongoose';\r\n\r\nimport { A7ModelType } from './a7-model';\r\nimport { ConvertModel } from './types';\r\nimport { DocumentModel, Model, lazyFns, shareFns } from './model';\r\nimport { SBaseMongooseConfig } from './model-config';\r\n\r\nexport class Discriminator extends DocumentModel {\r\n  public static $discriminator<\r\n    T extends ConvertModel<Document, any> & typeof Discriminator,\r\n    M extends typeof Model\r\n  >(\r\n    this: T,\r\n    m: M,\r\n  ): ConvertModel<T & InstanceType<M> & Document, T & InstanceType<M>> & T & M {\r\n    return discriminatorMultiTenancy(this, m);\r\n  }\r\n\r\n  public static $discriminatorA7Model<\r\n    T extends ConvertModel<Document, any> & typeof Discriminator,\r\n    M extends typeof Model\r\n  >(\r\n    this: T,\r\n    m: M,\r\n  ): ConvertModel<T & InstanceType<M> & Document, T & InstanceType<M>> &\r\n    T &\r\n    M &\r\n    A7ModelType {\r\n    return this.$discriminator(m) as any;\r\n  }\r\n}\r\n\r\nfunction discriminatorMultiTenancy<\r\n  T extends ConvertModel<Document, any>,\r\n  M extends typeof Model\r\n>(\r\n  model: T,\r\n  dm: M,\r\n): ConvertModel<T & InstanceType<M> & Document, T & InstanceType<M>> & T & M {\r\n  const sbaseConfig: SBaseMongooseConfig = (model as any).sbaseConfig;\r\n\r\n  if (!sbaseConfig.multiTenancy.enabled) {\r\n    const m = model.discriminator(\r\n      dm.name,\r\n      dm.$mongooseOptions().mongooseSchema,\r\n    ) as any;\r\n\r\n    m.sbaseConfig = sbaseConfig;\r\n\r\n    return m;\r\n  }\r\n\r\n  const tenants = ['default'].concat(sbaseConfig.multiTenancy.tenants);\r\n  const tenantMap: {\r\n    [key: string]: MModel<Document> & T;\r\n  } = {};\r\n\r\n  const currentTenantMap = (model as any)._proxy.$tenantMap;\r\n\r\n  for (const tenancy of tenants) {\r\n    const m = currentTenantMap[tenancy].discriminator(\r\n      dm.name,\r\n      dm.$mongooseOptions(sbaseConfig, tenancy).mongooseSchema,\r\n    );\r\n\r\n    m.sbaseConfig = sbaseConfig;\r\n\r\n    tenantMap[tenancy] = m;\r\n  }\r\n\r\n  const proxy: any = new Proxy<MModel<Document> & T>({} as any, {\r\n    get: (_obj: {}, prop: string) => {\r\n      if (lazyFns.indexOf(prop) >= 0) {\r\n        const ret = function () {\r\n          const t = sbaseConfig.multiTenancy.tenancyFn(prop);\r\n          const m1: any = tenantMap[t];\r\n          const actualFn = m1[prop];\r\n\r\n          return actualFn.apply(this, arguments);\r\n        };\r\n        return ret;\r\n      }\r\n\r\n      if (shareFns.indexOf(prop) >= 0) {\r\n        const ret = () => {\r\n          return _.map(tenants, (t) => {\r\n            const m2: any = tenantMap[t];\r\n            return m2[prop].apply(m2, arguments);\r\n          });\r\n        };\r\n        return ret;\r\n      }\r\n\r\n      const tenancy = sbaseConfig.multiTenancy.tenancyFn(prop);\r\n      const m: any = tenantMap[tenancy];\r\n      m._proxy = proxy;\r\n\r\n      if (prop === '$modelClass') {\r\n        return m;\r\n      }\r\n\r\n      const res = m[prop];\r\n      return _.isFunction(res) ? res.bind(m) : res;\r\n    },\r\n    set: (_obj: {}, prop: string, value: any) => {\r\n      const tenancy = sbaseConfig.multiTenancy.tenancyFn(prop);\r\n      const m: any = tenantMap[tenancy];\r\n      m[prop] = value;\r\n      return true;\r\n    },\r\n  });\r\n\r\n  return proxy;\r\n}\r\n"],"sourceRoot":"D:\\zyq\\ark-db/src"}